
```{r}
library(tidyverse)
library(duckdb)

source('helpers/helper_viz.R')

con <- dbConnect(duckdb(), 'data/bdb.duckdb')
tbl(con, "tracking_clean")
```


## Motion rates

```{r}
ftn <- nflreadr::load_ftn_charting(2022)
pbp <- nflreadr::load_pbp(2022)

nflverse_motion <- pbp |>
  filter(special == 0) |>
  select(game_id, old_game_id, play_id, posteam, pass_attempt, xpass, pass_oe) |>
  left_join(ftn |> select(game_id = nflverse_game_id, play_id = nflverse_play_id, is_motion))


nflverse_motion |>
  filter(!is.na(posteam), !is.na(xpass)) |>
  group_by(is_motion, xpass = round(xpass, 1)) |>
  summarise(
    pass = mean(pass_attempt, na.rm = TRUE)
  ) |>
  ggplot(aes(xpass, pass)) +
  geom_point() +
  geom_smooth(se = FALSE) +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(~is_motion)



```


```{r}
plays <- tbl(con, "plays")
player_play <- tbl(con, "player_play")

tracking_motion <- plays |>
  left_join(player_play, by = c("gameId", "playId")) |>
  mutate(motion = motionSinceLineset) |>
  group_by(possessionTeam, gameId, playId) |>
  summarise(
    players = n(),
    motion = max(as.numeric(motion))
  ) |>
  collect() |>
  group_by(possessionTeam) |>
  summarise(plays = n(), motion = sum(motion, na.rm = TRUE)) |>
  mutate(motion_rate = motion / plays) |>
  arrange(-motion_rate)


df_motion <- nflverse_motion |>
  left_join(tracking_motion, by = c('posteam' = 'possessionTeam'), suffix = c('.nflverse', '.ngs')) |>
  select(-motion.ngs) |>
  rename(motion.ngs = motion_rate)

df_motion |>
  ggplot(aes(motion.nflverse, motion.ngs)) +
  geom_point() +
  coord_cartesian(c(0.1, 0.75), c(0.1, 0.75)) +
  geom_abline(slope = 1, intercept = 0)

```



```{r}
tbl(con, "tracking_clean") |>
  left_join(tbl(con, "plays")) |> filter(pff_manZone == 'Zone') |> count(gameId, playId, expectedPointsAdded) |> arrange(-expectedPointsAdded)

```


```{r}
watch_film(2022091800, 3547)
```



```{r}

```
